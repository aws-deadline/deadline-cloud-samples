# Sample Conda recipes

## Basic usage

This directory contains job bundles for building a Conda recipe, and
a set of Conda recipes to use with them. By default, it will build
packages and then upload them to your job attachments bucket, into
a Conda channel at the location `s3://<my-job-attachments-bucket>/Conda/Default`.

For example, to build a Blender 4.1 Conda package:

```
$ ./submit-package-job blender-4.1
```

## Tasks

### Create a new recipe from PyPI

1. (Prerequisite) Create and activate a Conda or venv virtual environment to work with
   recipes.
    1. With conda: `conda create -n recipe-env python` and then `conda activate recipe-env`.
    2. With venv: `python -m venv /path/to/venv` and then `source /path/to/venv/bin/activate`.

2. Install the [grayskull](https://github.com/conda/grayskull) conda recipe creator,
    by running `pip install grayskull` or `conda install grayskull`.
3. In the `conda_recipes` directory, create a new subdirectory named as the PyPI package,
    then run `grayskull` to create the recipe within. This will download the sdist from PyPI
    to analyze its metadata, and then create the recipe. Here's an example for `deadline`.
    ```
    $ mkdir deadline
    $ cd deadline
    $ grayskull pypi deadline
    #### Initializing recipe for deadline (pypi) ####
    ...
    Build requirements:
      <none>
    Host requirements:
      - python >=3.8
      - hatchling
      - hatch-vcs
      - pip
    Run requirements:
      - python >=3.8
      - boto3 >=1.34.75
      - click >=8.1.7
      - pyyaml >=6.0
      - typing-extensions ==4.7.*  # [py==37]
      - python-xxhash ==3.4.*
      - jsonschema ==4.17.*
      - pywin32-on-windows ==306  # [win]
      - qtpy ==2.4.*
    ...
    ```
4. We found we needed to change `{{ PYTHON }}` to `python`, because during the build it was producing a path that didn't contain
   the Python binary. In some cases, we also had to change some of the dependency rules.
5. If the package name is different from the module name, for example because it adds to a namespace package,
   you'll need to update the `imports` tests it creates.

### Create a patch for a recipe

Sometimes the source code has bugs, or won't build without modifications. You can create
patch files to include in the recipe.

For example, the source tarballs we generate on GitHub do not work with this process,
so the recipes generated by grayskull fail during the build process.

Here is a procedure for generating a patch and adding it to the recipe.

1. Acquire the source archive, and commit it into a new ephemeral git repository.
    ```
    $ curl -OL https://github.com/aws-deadline/deadline-cloud/releases/download/0.47.3/deadline-0.47.3.tar.gz
    $ tar zxvf deadline-0.47.3.tar.gz
    $ cd deadline-0.47.3
    $ git init .
    $ git add .
    $ git commit -m "initial"
    ```
2. Apply your bug fixes.
    ```
    $ vim pyproject.toml
    ...
    $ git diff
    warning: in the working copy of 'pyproject.toml', LF will be replaced by CRLF the next time Git touches it
    diff --git a/pyproject.toml b/pyproject.toml
    index 893cbcd..94c0c50 100644
    --- a/pyproject.toml
    +++ b/pyproject.toml
    @@ -68,24 +68,6 @@ artifacts = [
    "*_version.py",
    ]

    -[tool.hatch.version]
    -source = "vcs"
    -
    -[tool.hatch.version.raw-options]
    -version_scheme = "post-release"
    -
    -[tool.hatch.build.hooks.vcs]
    -version-file = "_version.py"
    -
    -[tool.hatch.build.hooks.custom]
    -path = "hatch_custom_hook.py"
    -
    -[tool.hatch.build.hooks.custom.copy_version_py]
    -destinations = [
    -  "src/deadline/client",
    -  "src/deadline/job_attachments",
    -]
    -
    [tool.hatch.build.targets.sdist]
    include = [
    "src/*",
    ```
3. Commit the changes, and produce a diff file.
    ```
    $ git add -u
    $ git format-patch -1
    0001-Remove-version-build-hook.patch
    ```
4. Add the generated patch to the recipe, beside the `meta.yaml` file.
    ```
    $ mv 0001-Remove-version-build-hook.patch /path/to/recipe
    $ cd /path/to/recipe
    $ ls
    0001-Remove-version-build-hook.patch  meta.yaml
    $ vim meta.yaml
    ...
    $ git diff meta.yaml
    diff --git a/conda_recipes/deadline/deadline/meta.yaml b/conda_recipes/deadline/deadline/meta.yaml
    index 0d6bb1e..9b6621c 100644
    --- a/conda_recipes/deadline/deadline/meta.yaml
    +++ b/conda_recipes/deadline/deadline/meta.yaml
    @@ -8,6 +8,8 @@ package:
     source:
       url: https://pypi.io/packages/source/{{ name[0] }}/{{ name }}/deadline-{{ version }}.tar.gz
       sha256: fafc727d3e20aeb5c87b303b26a45801d5db8e97cc88997bec4bf76232035443
    +  patches:
    +    - 0001-Remove-version-build-hook.patch

     build:
       skip: true  # [py<38]
    ```
